<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel Admin - Registrar Compras</title>
</head>
<body style="font-family:Arial; margin:40px;">
  <h2>Registrar compra manual</h2>

  <label>Click ID:</label><br/>
  <input id="click_id" placeholder="Ej: A3F9KQ" style="width:200px;"/><br/><br/>

  <label>Teléfono del comprador (sin +):</label><br/>
  <input id="phone" placeholder="549XXXXXXXXXX" style="width:200px;"/><br/><br/>

  <label>Monto (ARS):</label><br/>
  <input id="value" placeholder="Ej: 3000" style="width:200px;"/><br/><br/>

  <button id="send" style="padding:10px 20px;">Enviar a Meta</button>

  <p id="status"></p>

  <script>
    const ACCESS_TOKEN = "TU_TOKEN_DE_ACCESO_DE_META"; // Reemplaza con tu token válido
    const PIXEL_ID = "1946841772846486";
    const SHEET_URL = "TU_URL_DEL_WEB_APP_DE_GOOGLE_SHEETS"; // misma que el index.html

    document.getElementById('send').addEventListener('click', async () => {
      const click_id = document.getElementById('click_id').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const value = parseFloat(document.getElementById('value').value.trim());
      const status = document.getElementById('status');

      if (!click_id || !phone || !value) {
        status.textContent = "Completa todos los campos.";
        return;
      }

      status.textContent = "Buscando datos en el sheet...";

      try {
        const res = await fetch(SHEET_URL);
        const text = await res.text();

        // Buscar el registro del click_id
        const row = text.split('\n').find(r => r.includes(click_id));
        if (!row) {
          status.textContent = "No se encontró el ID en la hoja.";
          return;
        }

        const [ , , fbp, fbc, event_id ] = row.split(',');

        // Enviar a Meta CAPI
        const payload = {
          data: [{
            event_name: "Purchase",
            event_time: Math.floor(Date.now() / 1000),
            event_id: event_id.trim(),
            user_data: {
              ph: phone, 
              fbp: fbp.trim(), 
              fbc: fbc.trim()
            },
            custom_data: {
              value: value,
              currency: "ARS"
            }
          }]
        };

        const response = await fetch(`https://graph.facebook.com/v18.0/${PIXEL_ID}/events?access_token=${ACCESS_TOKEN}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const json = await response.json();
        if (json.events_received) {
          status.textContent = "✅ Compra registrada correctamente en Meta.";
        } else {
          status.textContent = "⚠️ Error al enviar a Meta: " + JSON.stringify(json);
        }
      } catch (err) {
        status.textContent = "Error: " + err.message;
      }
    });
  </script>
</body>
</html>
