<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel Admin - Registrar Compras</title>
</head>
<body style="font-family:Arial; margin:40px;">
  <h2>Registrar compra manual</h2>

  <label>C√≥digo del cliente (lead_id):</label><br/>
  <input id="click_id" placeholder="Ej: N7XXA" style="width:200px;"/><br/><br/>

  <label>Tel√©fono del comprador (sin +):</label><br/>
  <input id="phone" placeholder="549XXXXXXXXXX" style="width:200px;"/><br/><br/>

  <label>Monto (ARS):</label><br/>
  <input id="value" placeholder="Ej: 3000" style="width:200px;"/><br/><br/>

  <button id="send" style="padding:10px 20px;">Enviar a Meta</button>

  <p id="status" style="font-weight:bold;"></p>

  <script>
    const ACCESS_TOKEN = "TU_TOKEN_DE_ACCESO_DE_META"; // üëà tu token real aqu√≠
    const PIXEL_ID = "1946841772846486";
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbwyADs1Mu32qEnFhwV4ySNK6Uaa3WzaCkDU_o3xFnhgMvXxvZcE3Pps6EGRguwyFhqq/exec"; // misma URL del index

    document.getElementById('send').addEventListener('click', async () => {
      const click_id = document.getElementById('click_id').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const value = parseFloat(document.getElementById('value').value.trim());
      const status = document.getElementById('status');

      if (!click_id || !phone || !value) {
        status.textContent = "‚ö†Ô∏è Completa todos los campos.";
        status.style.color = "orange";
        return;
      }

      status.textContent = "üîé Buscando datos en la hoja...";
      status.style.color = "white";

      try {
        // ‚úÖ 1. Obtener todos los datos de la hoja como texto
        const res = await fetch(SHEET_URL);
        const text = await res.text();

        // ‚úÖ 2. Buscar la fila correspondiente al click_id (lead_id)
        const line = text.split('\n').find(row => row.includes(click_id));
        if (!line) {
          status.textContent = "‚ùå No se encontr√≥ el c√≥digo en la hoja.";
          status.style.color = "red";
          return;
        }

        // ‚úÖ 3. Parsear los valores correctamente
        // Estructura esperada en la hoja:
        // timestamp | lead_id | fbp | fbc | event_id | name | phone
        const cols = line.split(',');
        const fbp = cols[2]?.trim() || "";
        const fbc = cols[3]?.trim() || "";
        const event_id = cols[4]?.trim() || "";

        if (!fbp && !fbc) {
          status.textContent = "‚ö†Ô∏è No se encontraron fbp/fbc en la hoja.";
          status.style.color = "orange";
          return;
        }

        // ‚úÖ 4. Crear el payload para Meta CAPI
        const payload = {
          data: [{
            event_name: "Purchase",
            event_time: Math.floor(Date.now() / 1000),
            event_id: event_id || ("purchase-" + click_id),
            user_data: {
              ph: phone,
              fbp: fbp,
              fbc: fbc
            },
            custom_data: {
              value: value,
              currency: "ARS"
            }
          }]
        };

        // ‚úÖ 5. Enviar evento a Meta
        const response = await fetch(`https://graph.facebook.com/v18.0/${PIXEL_ID}/events?access_token=${ACCESS_TOKEN}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const json = await response.json();
        console.log("Meta Response:", json);

        if (json.events_received) {
          status.textContent = "‚úÖ Compra registrada correctamente en Meta.";
          status.style.color = "#00ff88";
        } else {
          status.textContent = "‚ö†Ô∏è Error al enviar a Meta: " + JSON.stringify(json);
          status.style.color = "orange";
        }

      } catch (err) {
        console.error(err);
        status.textContent = "‚ùå Error de conexi√≥n o lectura: " + err.message;
        status.style.color = "red";
      }
    });
  </script>
</body>
</html>
